<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Particle Logo Transition Test (Improved)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #021222;
      overflow: hidden;
      font-family: 'Poppins', sans-serif;
      color: white;
    }

    canvas#particles-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
    }

    header, footer {
      text-align: center;
      padding: 1rem;
      z-index: 10;
      position: relative;
    }

    #page-content {
      position: relative;
      z-index: 5;
      text-align: center;
      margin-top: 3rem;
      transition: opacity 1.5s ease-in-out;
      opacity: 1;
    }

    #page-content.fade-out {
      opacity: 0;
    }

    a {
      color: #00b7ff;
      text-decoration: none;
      font-weight: 600;
      margin: 0 1rem;
    }
  </style>
</head>
<body>
  <header>
    <h2>Particle Transition Demo</h2>
    <nav>
      <a href="./transition-test.html">Home</a>
      <a href="./transition-test2.html">Go to Page 2</a>
    </nav>
  </header>

  <canvas id="particles-bg"></canvas>

  <div id="page-content">
    <h1>Welcome to the Test Page</h1>
    <p>This is a demonstration of the improved particle-logo transition.</p>
  </div>

  <footer>
    <p>© 2025 CVF Solutions</p>
  </footer>

  <script>
  // ===== Particle Background =====
  const canvas = document.getElementById('particles-bg');
  const ctx = canvas.getContext('2d');
  let w, h;
  let particles = [];
  function resize() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resize);
  resize();

  for (let i = 0; i < 150; i++) {
    particles.push({
      x: Math.random() * w,
      y: Math.random() * h,
      vx: (Math.random() - 0.5) * 0.5,
      vy: (Math.random() - 0.5) * 0.5,
      size: 1.8
    });
  }

  function draw() {
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = 'rgba(0,200,255,0.8)';
    ctx.strokeStyle = 'rgba(0,200,255,0.25)';
    ctx.lineWidth = 1;
    for (let i = 0; i < particles.length; i++) {
      const p = particles[i];
      p.x += p.vx;
      p.y += p.vy;
      if (p.x < 0 || p.x > w) p.vx *= -1;
      if (p.y < 0 || p.y > h) p.vy *= -1;

      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();

      for (let j = i + 1; j < particles.length; j++) {
        const q = particles[j];
        const dx = p.x - q.x;
        const dy = p.y - q.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 100) {
          ctx.beginPath();
          ctx.moveTo(p.x, p.y);
          ctx.lineTo(q.x, q.y);
          ctx.stroke();
        }
      }
    }
    requestAnimationFrame(draw);
  }
  draw();
  window.particlesArray = particles;
  </script>

  <script>
  // ===== Transition Logic =====
  document.addEventListener("DOMContentLoaded", () => {
    const content = document.getElementById("page-content");
    const canvas = document.getElementById("particles-bg");
    const ctx = canvas.getContext("2d");
    const particles = window.particlesArray;

    const logoImg = new Image();
    logoImg.src = "./images/logo.jpg"; // <-- ensure this path works

    function getLogoPoints(img, widthFraction = 0.3) {
      const tmp = document.createElement("canvas");
      const scale = (canvas.width * widthFraction) / img.width;
      const scaledW = img.width * scale;
      const scaledH = img.height * scale;
      tmp.width = scaledW;
      tmp.height = scaledH;
      const tctx = tmp.getContext("2d");
      tctx.drawImage(img, 0, 0, scaledW, scaledH);
      const imageData = tctx.getImageData(0, 0, scaledW, scaledH).data;

      const pts = [];
      for (let y = 0; y < scaledH; y += 3) {  // denser sampling
        for (let x = 0; x < scaledW; x += 3) {
          const i = (y * scaledW + x) * 4;
          if (imageData[i + 3] > 128) pts.push({ x, y });
        }
      }
      const offsetX = canvas.width / 2 - scaledW / 2;
      const offsetY = canvas.height / 2 - scaledH / 2;
      return pts.map(p => ({ x: p.x + offsetX, y: p.y + offsetY }));
    }

    function morphParticlesToLogo(points) {
      const total = particles.length;
      for (let i = 0; i < total; i++) {
        const p = particles[i];
        const target = points[i % points.length];
        p.vx = (target.x - p.x) * 0.01;
        p.vy = (target.y - p.y) * 0.01;
      }
    }

    function disperseParticles() {
      particles.forEach(p => {
        p.vx = (Math.random() - 0.5) * 0.5;
        p.vy = (Math.random() - 0.5) * 0.5;
      });
    }

    function playTransitionAndNavigate(href) {
      content.classList.add("fade-out");
      morphParticlesToLogo(window.logoPoints);
      setTimeout(() => window.location.assign(href), 3000); // ⏳ slower for full effect
    }

    logoImg.onload = () => {
      window.logoPoints = getLogoPoints(logoImg);
      // For testing, show the morph on page load then disperse
      setTimeout(() => {
        morphParticlesToLogo(window.logoPoints);
        setTimeout(() => disperseParticles(), 2500);
      }, 800);
    };

    document.querySelectorAll("a").forEach(link => {
      const href = link.getAttribute("href");
      if (href && !href.startsWith("#") && !href.startsWith("mailto")) {
        link.addEventListener("click", e => {
          e.preventDefault();
          playTransitionAndNavigate(href);
        });
      }
    });
  });
  </script>
</body>
</html>
